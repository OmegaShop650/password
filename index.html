<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è | OmegaShop</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />

  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div class="container">
    <!-- –í—Ö—ñ–¥ -->
    <div class="box" id="login-box">
      <h2>–í—Ö—ñ–¥</h2>
      <input type="text" id="login" placeholder="–õ–æ–≥—ñ–Ω (—Ç—ñ–ª—å–∫–∏ –∞–Ω–≥–ª –±—É–∫–≤–∏)" autocomplete="username" />
      <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password" />
      <button onclick="login()">–£–≤—ñ–π—Ç–∏</button>
      <p class="error" id="error"></p>
      <p class="switch-text">
        –ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç—É? <a href="#" onclick="showRegister(event)">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</a>
      </p>

      <p>–ê–±–æ —É–≤—ñ–π–¥—ñ—Ç—å —á–µ—Ä–µ–∑ Google:</p>
      <div id="g_id_onload"
           data-client_id="408505306218-8ae6o2bsr8k3pvm3g772le0eee2oujik.apps.googleusercontent.com"
           data-callback="handleCredentialResponse"
           data-auto_prompt="false">
      </div>
      <div class="g_id_signin" data-type="standard"></div>
    </div>

    <!-- –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è -->
    <div class="box" id="register-box" style="display:none;">
      <h2>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h2>
      <input type="text" id="reg-login" placeholder="–õ–æ–≥—ñ–Ω (—Ç—ñ–ª—å–∫–∏ –∞–Ω–≥–ª –±—É–∫–≤–∏)" autocomplete="username" />
      <input type="password" id="reg-password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="new-password" />
      <input type="password" id="reg-password2" placeholder="–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø–∞—Ä–æ–ª—è" autocomplete="new-password" />
      <button onclick="register()">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
      <p class="error" id="reg-error"></p>
      <p class="switch-text">
        –í–∂–µ –º–∞—î—à –∞–∫–∞—É–Ω—Ç? <a href="#" onclick="showLogin(event)">–£–≤—ñ–π—Ç–∏</a>
      </p>
    </div>
  </div>

<script>
  // –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –ª–æ–≥—ñ–Ω–∞ (—Ç—ñ–ª—å–∫–∏ –∞–Ω–≥–ª—ñ–π—Å—å–∫—ñ –ª—ñ—Ç–µ—Ä–∏)
  function filterLoginInput(input) {
    return input.replace(/[^a-zA-Z]/g, '');
  }

  document.getElementById('login').addEventListener('input', function (e) {
    const filtered = filterLoginInput(e.target.value);
    if (e.target.value !== filtered) {
      e.target.value = filtered;
    }
  });

  document.getElementById('reg-login').addEventListener('input', function (e) {
    const filtered = filterLoginInput(e.target.value);
    if (e.target.value !== filtered) {
      e.target.value = filtered;
    }
  });

  // –§—É–Ω–∫—Ü—ñ—è –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ Telegram (—Ç—É—Ç –∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é, —â–æ–± –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ 1 —Ä–∞–∑)
  function sendTelegramMessage(username) {
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤–∂–µ –Ω–∞–¥—Å–∏–ª–∞–ª–∏ –¥–ª—è —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    let sentUsers = JSON.parse(localStorage.getItem('telegramSentUsers')) || [];
    if (sentUsers.includes(username)) {
      return; // –í–∂–µ –Ω–∞–¥—Å–∏–ª–∞–ª–∏, –Ω–µ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–Ω–æ–≤—É
    }

    const token = "8102622568:AAEGVR7H4HtOvL1IzI2M9wOvC6WQSa2qikg";
    const chat_id = "751873408";
    const message = `üîê –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —É–≤—ñ–π—à–æ–≤: ${username}`;

    fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ chat_id: chat_id, text: message })
    });

    // –î–æ–¥–∞—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–æ —Å–ø–∏—Å–∫—É —Ç–∏—Ö, –∫–æ–º—É –≤–∂–µ –≤—ñ–¥–ø—Ä–∞–≤–∏–ª–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    sentUsers.push(username);
    localStorage.setItem('telegramSentUsers', JSON.stringify(sentUsers));
  }

  // –í—Ö—ñ–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  function login() {
    const loginInput = document.getElementById("login").value.trim().toLowerCase();
    const passwordInput = document.getElementById("password").value.trim();
    const error = document.getElementById("error");

    if (!/^[a-z]+$/.test(loginInput)) {
      error.textContent = "–õ–æ–≥—ñ–Ω –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ –∞–Ω–≥–ª—ñ–π—Å—å–∫—ñ –ª—ñ—Ç–µ—Ä–∏!";
      return;
    }

    let users = JSON.parse(localStorage.getItem("users")) || {};

    if (users[loginInput] && users[loginInput].password === passwordInput) {
      localStorage.setItem("loggedIn", loginInput);

      sendTelegramMessage(loginInput);

      window.location.href = "success.html";
    } else {
      error.textContent = "‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ª–æ–≥—ñ–Ω –∞–±–æ –ø–∞—Ä–æ–ª—å.";
    }
  }

  // –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (–±–µ–∑ email)
  function register() {
    const loginInput = document.getElementById("reg-login").value.trim().toLowerCase();
    const passwordInput = document.getElementById("reg-password").value.trim();
    const password2Input = document.getElementById("reg-password2").value.trim();
    const error = document.getElementById("reg-error");

    if (!loginInput || !passwordInput || !password2Input) {
      error.textContent = "‚ùå –í—Å—ñ –ø–æ–ª—è –º–∞—é—Ç—å –±—É—Ç–∏ –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ.";
      return;
    }

    if (!/^[a-z]+$/.test(loginInput)) {
      error.textContent = "–õ–æ–≥—ñ–Ω –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ –∞–Ω–≥–ª—ñ–π—Å—å–∫—ñ –ª—ñ—Ç–µ—Ä–∏!";
      return;
    }

    if (passwordInput !== password2Input) {
      error.textContent = "‚ùå –ü–∞—Ä–æ–ª—ñ –Ω–µ —Å–ø—ñ–≤–ø–∞–¥–∞—é—Ç—å.";
      return;
    }

    let users = JSON.parse(localStorage.getItem("users")) || {};

    if (users[loginInput]) {
      error.textContent = "‚ùå –¶–µ–π –ª–æ–≥—ñ–Ω –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è.";
      return;
    }

    users[loginInput] = { password: passwordInput };
    localStorage.setItem("users", JSON.stringify(users));

    alert("‚úÖ –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –ø—Ä–æ–π—à–ª–∞ —É—Å–ø—ñ—à–Ω–æ! –¢–µ–ø–µ—Ä —É–≤—ñ–π–¥—ñ—Ç—å.");
    showLogin();
  }

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–Ω—è –º—ñ–∂ —Ñ–æ—Ä–º–∞–º–∏
  function showRegister(event) {
    if(event) event.preventDefault();
    document.getElementById("login-box").style.display = "none";
    document.getElementById("register-box").style.display = "block";
    clearErrors();
  }

  function showLogin(event) {
    if(event) event.preventDefault();
    document.getElementById("login-box").style.display = "block";
    document.getElementById("register-box").style.display = "none";
    clearErrors();
  }

  // –û—á–∏—Å—Ç–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –ø—Ä–æ –ø–æ–º–∏–ª–∫–∏
  function clearErrors() {
    document.getElementById("error").textContent = "";
    document.getElementById("reg-error").textContent = "";
  }

  // Google Sign-In –æ–±—Ä–æ–±–∫–∞
  function handleCredentialResponse(response) {
    try {
      const token = response.credential;
      const payload = JSON.parse(atob(token.split('.')[1]));
      const name = payload.name || "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á";
      const email = payload.email || "";
      const googleId = payload.sub; // —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä Google

      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —É–∂–µ –≤ –ª–æ–∫–∞–ª—Å—Ç–æ—Ä–µ–¥–∂
      let users = JSON.parse(localStorage.getItem("users")) || {};

      if (!users[googleId]) {
        // –°—Ç–≤–æ—Ä—é—î–º–æ –æ–±'—î–∫—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —ñ–∑ –ø–∞—Ä–æ–ª–µ–º null, –±–æ –ø–∞—Ä–æ–ª—å –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω
        users[googleId] = { password: null, name: name, email: email, google: true };
        localStorage.setItem("users", JSON.stringify(users));

        // –ù–∞–¥—Å–∏–ª–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —Ç–µ–ª–µ–≥—Ä–∞–º, –±–æ —Ü–µ –ø–µ—Ä—à–∏–π –≤—Ö—ñ–¥
        sendTelegramMessage(name);
      }

      localStorage.setItem('loggedInGoogleToken', token);
      localStorage.setItem('loggedIn', googleId);

      history.replaceState(null, null, window.location.pathname);
      window.location.href = "success.html";

    } catch (e) {
      alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥—ñ —á–µ—Ä–µ–∑ Google.");
    }
  }
</script>
</body>
</html>
